{% extends "home/header.html" %}

{% block content %}
<head>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.7.16.min.js"></script>

<script>
AWS.config.update({
  region: "us-east-1",
  endpoint: 'https://dynamodb.us-east-1.amazonaws.com',
  // accessKeyId default can be used while using the downloadable version of DynamoDB. 
  // For security reasons, do not store AWS Credentials in your files. Use Amazon Cognito instead.
  accessKeyId: "AKIAIDPTL2CIAJMCACQA",
  // secretAccessKey default can be used while using the downloadable version of DynamoDB. 
  // For security reasons, do not store AWS Credentials in your files. Use Amazon Cognito instead.
  secretAccessKey: "isSvCBz6z9Xss8iWfh/wHnA6BqODZxwjjjynLLDK"
});

var docClient = new AWS.DynamoDB.DocumentClient();
var dynamodb = new AWS.DynamoDB();
var username = "-1";
var myTableName = "-1";
var myLists = "-1";
var tableNames = new AWS.DynamoDB();
   dynamodb.listTables(function(err, data) {
   tableNames = data.TableNames;
});

function userLogin() {
    let uname = document.getElementById("loginUsername").value;
    let temp = uname + "_MYLISTS";
    console.log(temp);
    console.log(tableNames);
    if ($.inArray(temp, tableNames) > -1) {
        username = uname;
        myTableName = temp;
        console.log(myTableName);
        alert("Login success.");
        getAllLists();
    } else {
        alert("This username does not exist.");
    }
}

function userLogout() {
    username = "-1";
    myTableName = "-1";
    alert("Logout success.");
}

function getAllLists() {
    var params = {
        TableName: myTableName,
    };

    docClient.scan(params, onScan);

    function onScan(err, data) {
        if (err) {
            alert("Error: Could not retrieve your lists.");
        } else {
            $("#listModals").empty();
            $("#lists").empty();
            data.Items.forEach(function(myList) {
                appendListButton(myList.ListName);
                appendModal(myList);
            });          
        }
    }
}

function appendListButton(myListName) {
    var listButton = "\
        <li>\
            <a href=\"#portfolioModal"+myListName+"\" data-toggle=\"modal\" class=\"btn btn-default btn-lg\"><i class=\"fa fa-vimeo fa-fw\"></i> <span>"+myListName+"\
            </span>\
                <div class=\"portfolio-hover-content\">\
                </div>\
            </a>\
        </li>"
    $("#lists").append(listButton);
}

function buildChecklist(myList) {
    let sortedList = myList.Items.sort();
    let checklist = "";
    console.log(myList.Items);
    for (i in sortedList) {
        if (sortedList[i] == null) {
            console.log("null");
        }
        else if ($.inArray(sortedList[i], myList.Checked) > -1) {
            checklist = checklist + "\n <li><input type=\"checkbox\" checked><label>"+sortedList[i]+"</label></li>\ ";
        } else {
            checklist = checklist + "\n <li><input type=\"checkbox\"><label>"+sortedList[i]+"</label></li>\ ";
        }
    }
    return checklist;
}

function appendModal(myList) {
    let myListName = myList.ListName;
    let myID = "portfolioModal" + myListName;
    var myModal = "\
            <div class=\"portfolio-modal modal fade\" id=\"" +myID+ "\" tabindex=\"-1\" role=\"dialog\" aria-hidden=\"true\">\
                <div class=\"modal-content\">\
                    <h2>"+myListName+"</h2>\
                    <br>\
                    <ul id=\""+ myListName +"Checklist\" class=\"list-unstyled\">\ "
                    + buildChecklist(myList) +   
                    "</ul>\
                    <div class=\"lr\">\
                        <div class=\"rl\">\
                            <div class = \"container\">\
                            <form action=\"#\" method=\"post\">\
                                <div class=\"input-group\">\
                                    <input type=\"text\" name=\"message\" placeholder=\"Type an item name to add to the list\" class=\"form-control\">\
                                        {% csrf_token %}\
                                        <span class=\"input-group-btn\">\
                                            <button type=\"submit\" class=\"btn btn-primary btn-flat\">Submit ADD</button>\
                                        </span>\
                                </div>\
                                <div class=\"input-group\">\
                                    <input type=\"text\" name=\"message1\" placeholder=\"Type an existing item name to remove from the list\" class=\"form-control\">\
                                        {% csrf_token %}\
                                        <span class=\"input-group-btn\">\
                                            <button type=\"submit\" class=\"btn btn-primary btn-flat\">Submit Remove</button>\
                                        </span>\
                                </div>\
                            </div>\
                            </form>\
                        </div>\
                        <br>\
                        <button id=\"refreshButton\" type=\"button\" class=\"btn btn-primary\" data-dismiss=\"modal\"><i class=\"fa fa-refresh\"></i> Update </button>\
                        <button type=\"button\" class=\"btn btn-primary\" data-dismiss=\"modal\"><i class=\"fa fa-times\"></i> Close </button>\
                </div>\
            </div>";
    $("#listModals").append(myModal);
}

                        // <button id=\"deleteButton\" type=\"button\" class=\"btn btn-primary\" data-dismiss=\"modal\"><i class=\"fa fa-minus\"></i> Delete this List</button>\
                        // <br>\
// Array.prototype.remove = function() {
//     var what, a = arguments, L = a.length, ax;
//     while (L && this.length) {
//         what = a[--L];
//         while ((ax = this.indexOf(what)) !== -1) {
//             this.splice(ax, 1);
//         }
//     }
//     return this;
// };

function submitList() {
    event.preventDefault();
    let title = document.getElementById('recipeTitle').value;
    let ingredients = document.getElementById('ingredients').value.split('\n');
    let ingredientsSifted = [];
    for (i = 0; i < ingredients.length; i++) {
        if (ingredients[i] != "") {
            ingredientsSifted.push(ingredients[i]);
        }
    }
    console.log(ingredientsSifted);
    createList(title, ingredientsSifted);
}

function createList(title, ingredients) {
    var table = myTableName;

    var params = {
        TableName: table,
        Item:{
            "ListName": title,
            "Items": ingredients,
            "Checked": [null],
            "Unchecked": ingredients
        }
    };
    docClient.put(params, function(err, data) {
        if (err) {
            alert("Error: Could not create your list.");
        } else {
            getAllLists();
            alert("List has been successfully added.")
        }
    });
}

function getList(listName) {
    var table = myTableName;

    var params = {
        TableName: table,
        Key:{
            "ListName": listName
        }
    };
    docClient.get(params, function(err, data) {
        if (err) {
            document.getElementById('textarea').innerHTML = "Unable to read item: " + "\n" + JSON.stringify(err, undefined, 2);
        } else {
            return JSON.stringify(data, undefined, 2);
        }
    });
}

function updateList(listName, checkedList, uncheckedList) {
    var table = myTableName;

    var params = {
        TableName:table,
        Key:{
            "ListName": listName
        },
        UpdateExpression: "set checked = :c",
        ExpressionAttributeValues:{
            ":c":checkedList,
            ":u":uncheckedList
        },
        ReturnValues:"UPDATED_NEW"
    };

    docClient.update(params, function(err, data) {
        if (err) {
            getAllLists();
            alert("Update failed");
        } else {
            alert("Update success");
        }
    });
}

function deleteList(listName) {
    var table = "Movies";

    var params = {
        TableName:table,
        Key:{
            "ListName": listName
        },
    };

    docClient.delete(params, function(err, data) {
        if (err) {
            alert("Delete failed");
        } else {
            alert("Delete success");
        }
    });
}

</script>
</head>
<body>

    <!-- Navigation -->
    <nav id="mainNav" class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span> Menu <i class="fa fa-bars"></i>
                </button>
                <a class="navbar-brand page-scroll" href="#page-top">Packing List Helper</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="hidden">
                        <a href="#page-top"></a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#contact">Add a New Packing List</a>
                    </li>
                    <li>
                        <a class="page-scroll" href="#rec">Reccomendations</a>
                    </li>
                    <li class="dropdown user user-menu">
            <!-- Menu Toggle Button -->
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
              <!-- The user image in the navbar-->
              <!-- hidden-xs hides the username on small devices so only the image appears. -->
              <span id="user-name2" class="hidden-xs">Account</span>
            </a>
            <ul class="dropdown-menu">
              <!-- The user image in the menu -->
              <li class="user-header">
                <p>
                  <!-- <div id="user-name">Username</div> -->
                  <div id="user-coupons"><small>Please enter your provided username</small></div>

                </p>

              </li>
              <!-- Menu Body -->
              <li class="user-body">
                
                    <p>
                    <form>
                        
                        <input id="loginUsername" type="text" name="Username" placeholder="Username"><br>
                        
                    </form>
                    </p>
                  
                  <div id="checkdata"></div>
                
                <!-- /.row -->
              </li>
              <!-- Menu Footer-->
              <li class="user-footer">
                <div class="pull-left">
                  <button type="button" class="btn btn-default btn-flat" onclick="userLogin()">Log In</button>
                </div>
                <div class="pull-right">
                  <button type="button" class="btn btn-default btn-flat" onclick="userLogout()">Log Out</button>
                </div>
              </li>
            </ul>
          </li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container-fluid -->
    </nav>


    <!-- Header -->
   
    <div class="intro-header">
        <div class="container">

            <div class="row">
                <div class="col-lg-12">
                    <div class="intro-message">
                        <section id="portfolio">
                        <h1>Packing Lists</h1>
                        <h3>Select a Packing List Below</h3>
                        <hr class="intro-divider">
                        <ul id = "lists" class="list-inline intro-social-buttons">
                        <!-- THIS IS WHERE BUTTONS FOR EACH LIST GO -->
                        </ul>
                        <a href="#contact" class="page-scroll btn btn-xl" class="page-scroll">Add a New Packing List</a>
                    </section>
                        
                    </div>
                </div>
            </div>

        </div>
        <!-- /.container -->

    </div>
</body>



<section id="rec">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2 class="section-heading">Recommended Lists</h2>
                </div>
            </div>
            <div class="row text-center">
                <a href ="#portfolioModal1" data-toggle="modal">
                <div class="col-md-4">
                    <span class="fa-stack fa-4x">
                        <i class="fa fa-circle fa-stack-2x text-primary"></i>
                        <i class="fa fa-laptop fa-stack-1x fa-inverse"></i>
                    </span>  
                    <h4 class="service-heading">Work</h4>
                </div>
                </a>
                <a href ="#portfolioModal2" data-toggle="modal">
                <div class="col-md-4">
                    <span class="fa-stack fa-4x">
                        <i class="fa fa-circle fa-stack-2x text-primary"></i>
                        <i class="fa fa-book fa-stack-1x fa-inverse"></i>
                    </span>
                    <h4 class="service-heading">School</h4>
                    
                </div>
                </a>
                <a href ="#portfolioModal3" data-toggle="modal">
                <div class="col-md-4">
                    <span class="fa-stack fa-4x">
                        <i class="fa fa-circle fa-stack-2x text-primary"></i>
                        <i class="fa fa-support fa-stack-1x fa-inverse"></i>
                    </span>
                    <h4 class="service-heading">Beach</h4>
                    
                </div>
            </a>
            </div>
        </div>
    </section>

    <section id="contact">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2 class="section-heading">Add a New Packing List</h2>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12">
                    <form name="sentMessage" id="contactForm" novalidate>
                        <div class="row">
                            <div class="col-md-6 col-md-offset-3">
                                <div class="form-group">
                                    <input type="text" class="form-control" placeholder="Packing List Name *" id="recipeTitle" required="" data-validation-required-message="Please enter a name for your packing list." aria-invalid="false">
                                    <p class="help-block text-danger"></p>
                                </div>
                            
                                <div class="form-group">
                                    <textarea class="form-control" placeholder="Items **ENTER ONE ITEM PER LINE**" id="ingredients" required data-validation-required-message="List the Items line by line."></textarea>
                                    <p class="help-block text-danger"></p>
                                </div>
                            </div>
                            <div class="clearfix"></div>
                            <div class="col-lg-12 text-center">
                                <div id="success"></div>
                                <button type="submit" class="btn btn-xl" onclick="submitList()">Sumbit List</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <section id="listModals">
        <!-- THIS IS WHERE WE APPEND THE MODALS -->
    </section>
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <ul class="list-inline">
                        <li>
                            <a href="#">Home</a>
                        </li>
                        <li class="footer-menu-divider">&sdot;</li>
                    </ul>
                    <p class="copyright text-muted small">Packing List Helper Prototype</p>
                </div>
            </div>
        </div>
    </footer>

    <div id="list-view">
        
    </div>

    {% load staticfiles %}
    <!-- jQuery -->
    <script src="{% static 'vendor/jquery/jquery.min.js' %}"></script>
    <!-- Bootstrap Core JavaScript -->
    <script src="{% static 'vendor/bootstrap/js/bootstrap.min.js' %}"></script>
    <!-- Plugin JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js" integrity="sha384-mE6eXfrb8jxl0rzJDBRanYqgBxtJ6Unn4/1F7q4xRRyIw7Vdg9jP4ycT7x1iVsgb" crossorigin="anonymous"></script>

    <!-- Contact Form JavaScript -->
    <script src="{% static 'js/jqBootstrapValidation.js' %}"></script>
    <!-- <script src="{% static 'js/contact_me.js' %}"></script> -->

    <!-- Theme JavaScript -->
    <script src="{% static 'js/agency.min.js' %}"></script>
    <!-- <script type="{% static 'js/facebook.js' %}" charset="utf-8"></script> -->

    <!-- DynamoDB JavaScript -->
    <!-- <script src="{% static 'js/recipe_list.js' %}"></script> -->

</body>
{% endblock %}
